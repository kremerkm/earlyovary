---
title: "Survival Outcomes of Early-Stage High Grade Serous Ovarian Cancer Using the SEER Cancer Database"
author: "Kevin Kremer"
date: "10/9/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(SEER2R)
library(zoo)
library(survival)
library(survminer)
library(kableExtra)
library(RColorBrewer)

#Read SEER case files for ovarian cancer from 2004-2016 into data.frame
ovary.df <- read.SeerStat("ovcase_2004-2016.dic", UseVarLabelsInData = TRUE)

#Change data.frame to tibble
ovary.tib <- as_tibble(ovary.df)

#Rename columns
ovary.tib = rename(ovary.tib,
            Race = "Race_and_origin_recode_NHW_NHB_NHAIAN_NHAPI_Hispanic",
            Histo = "Histologic_Type_ICDO3",
            Lat = "Laterality",
            Summ_Stage = "SEER_Combined_Summary_Stage_2000_2004",
            Stage_Group = "Derived_AJCC_Stage_Group_6th_ed_20042015",
            T_Stage = "Derived_AJCC_T_6th_ed_20042015",
            N_Stage = "Derived_AJCC_N_6th_ed_20042015",
            M_Stage = "Derived_AJCC_M_6th_ed_20042015",
            Nodes_Ex = "Regional_nodes_examined_1988",
            Nodes_Pos = "Regional_nodes_positive_1988",
            Chemo = "Chemotherapy_recode_yes_no/unk",
            DiagYear = "Year_of_diagnosis",
            SurvMonths = "Survival_months",
            COD = "SEER_causespecific_death_classification",
            DiagAge = "Age_at_diagnosis",
            CutoffStatus = "Vital_status_recode_study_cutoff_used",
            DiagMonth = "Month_of_diagnosis_recode",
            CutoffStatus2 = "End_Calc_Vital_Status_Adjusted",
            MonthsFollowed = "Number_of_Intervals_Calculated")

#Remove columns
ovary.tib = select(ovary.tib, -c(Summary_stage_2000_1998, Sex, County, CutoffStatus2, Begin_Calc_Age_Adjusted))

#Change Grades to numeric values
ovary.tib$Grade <- ifelse(ovary.tib$Grade == "Poorly differentiated; Grade III", 3,
        ifelse(ovary.tib$Grade == "Moderately differentiated; Grade II", 2, 
        ifelse(ovary.tib$Grade == "Well differentiated; Grade I", 1,
        ifelse(ovary.tib$Grade == "Undifferentiated; anaplastic; Grade IV", 4, "Unk"))))

#Change Lat to Right/Left/Bil
ovary.tib$Lat <- ifelse(ovary.tib$Lat == "Right - origin of primary", "R",
        ifelse(ovary.tib$Lat == "Left - origin of primary", "L", 
        ifelse(ovary.tib$Lat == "Bilateral, single primary", "Bil", "Unk")))

#Change Race to manageable names
ovary.tib$Race <- ifelse(ovary.tib$Race == "Hispanic (All Races)", "Hisp",
        ifelse(ovary.tib$Race == "Non-Hispanic Asian or Pacific Islander", "API",
        ifelse(ovary.tib$Race == "Non-Hispanic American Indian/Alaska Native", "Native",
        ifelse(ovary.tib$Race == "Non-Hispanic Black", "Black",
        ifelse(ovary.tib$Race == "Non-Hispanic White", "White", "Unk")))))

#Change Nodes_Ex to None, Inadequate, Adequate
ovary.tib$Nodes_Ex <- ifelse(ovary.tib$Nodes_Ex == 0, "None",
        ifelse(ovary.tib$Nodes_Ex > 0 & ovary.tib$Nodes_Ex < 10, "Inadequate", "Adequate"))

#Change Nodes_Pos to Yes/No
ovary.tib$Nodes_Pos <- ifelse(ovary.tib$Nodes_Pos == 0, "No",
                    ifelse(ovary.tib$Nodes_Pos == 98, "Unk", "Yes"))

#Change COD variable to Alive(0) or Dead(1)
ovary.tib$COD <- ifelse(ovary.tib$COD == "Alive or dead of other cause", 0, 1)

#Filter out HGSOC and add column for race and age groups
serous <- filter(ovary.tib, Histo == "441" | Histo == "460" | Histo == "461" )
HGS <- filter(serous, Grade == 3 | Grade == 4)
HGS = mutate(HGS, Black.Race = ifelse(HGS$Race == "Black", "yes", "no") )
HGS = mutate(HGS, Race.Group = ifelse(HGS$Race == "Black", "Black",
                                      ifelse(HGS$Race == "White", "White","Other")))
HGS = mutate(HGS, TNM.Stage = ifelse(Nodes_Pos == "No" & M_Stage == "M0", "T1N0M0",
                                     ifelse(Nodes_Pos == "Unk" & M_Stage == "M0", "T1NxM0",
                                            ifelse(Nodes_Pos == "Yes" & M_Stage == "M0", "T1N1M0", "Any M1"))))
HGS.White.Black <- filter(HGS, HGS$Race == "Black" | HGS$Race == "White")
HGS$Age.Group <- cut(HGS$DiagAge, breaks = c(18, 30, 40, 50, 60 ,70, 80, 120), labels = c("18-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+"), right = FALSE)
HGS.ES <- filter(HGS,(Nodes_Pos == "No" | Nodes_Pos == "Unk") & M_Stage == "M0")
HGS.N0 <- filter(HGS, Nodes_Pos == "No" & M_Stage == "M0")
HGS.Nx <- filter (HGS, Nodes_Pos == "Unk" & M_Stage == "M0")
HGS.late <- filter (HGS, Nodes_Pos == "Yes" & M_Stage == "M0")
HGS.mets <- filter(HGS, M_Stage == "M1")
```

# OS based on stage
```{r, echo=FALSE}
#change order of Strata
HGS$TNM.Stage <- factor(HGS$TNM.Stage, levels = c('T1N0M0', 'T1NxM0', 'T1N1M0', 'Any M1'))
fit.byStage <- survfit(Surv(SurvMonths, COD) ~ TNM.Stage, data = HGS)
ggsurvplot(fit.byStage, data = HGS, test.for.trend = TRUE, xlab = "Months", break.time.by = 12, break.y.by = 0.1, title = "Survival Stratified by TNM Stage", legend.labs = c("T1N0M0", "T1NxM0", "T1N1M0", "Any M1"), legend.title = "Stage", legend = "bottom", palette = "Set1", ggtheme = theme_gray())
pairwise_survdiff(Surv(SurvMonths, COD) ~ TNM.Stage, HGS, rho = 0)
```

# For presumed early-stage HGSOC, does adequacy of LN evaluation matter?

```{r, echo=FALSE}
fit.byLND <- survfit(Surv(SurvMonths, COD) ~ Nodes_Ex, data = HGS.ES)
ggsurvplot(fit.byLND, HGS.ES, xlab = "Months", break.time.by = 12, break.y.by = 0.1, title = "Survival of presumed early-stage HGSOC stratified \nby lymph node dissection", legend = "bottom", legend.title = "Lymphadenectomy", legend.labs = c("Adequate", "Inadequate", "None"), palette = "Set1", ggtheme = theme_gray())
pairwise_survdiff(Surv(SurvMonths, COD) ~ Nodes_Ex, HGS.ES, rho = 0)
HGS.ES.byLNDtbl <- table(HGS.ES$Nodes_Ex)
kbl(HGS.ES.byLNDtbl, col.names = c("Lymphadenectomy", "Count")) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
```{r, echo = FALSE}
ph.byLND <- coxph(Surv(SurvMonths, COD) ~ Nodes_Ex, HGS.ES)
ggforest(ph.byLND, HGS.ES)
summary(ph.byLND)
```

# In patient's without LND, does adding chemo change their survival?

```{r, echo = FALSE}
HGS.ES.chemo = filter(HGS.ES, Chemo == "Yes")
fit.ES.chemo <- survfit(Surv(SurvMonths, COD) ~ Nodes_Pos, HGS.ES.chemo)
ggsurvplot(fit.ES.chemo, HGS.ES.chemo, pval = TRUE, xlab = "Months", break.time.by = 12, break.y.by = 0.1, legend.title = "Stage", legend.labs = c("T1N0M0", "T1NxMO"), title = "Survival of presumed early-stage HGSOC with chemotherapy", palette = "Set1", ggtheme = theme_gray())
HGS.ES.chemotbl <- table(HGS.ES.chemo$Nodes_Pos)
kbl(HGS.ES.chemotbl, col.names = c("Positive Nodes", "Count")) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
```{r, echo = FALSE}
ph.ES.chemo <- coxph(Surv(SurvMonths, COD) ~ Nodes_Pos, HGS.ES.chemo)
ggforest(ph.ES.chemo, HGS.ES.chemo)
summary(ph.ES.chemo)
```

# Survival difference between N0 patients with and without chemotherapy

```{r, echo = FALSE}
HGS.N0$Chemo <- factor(HGS.N0$Chemo, levels = c('Yes', 'No/Unknown'))
fit.N0.bychemo <- survfit(Surv(SurvMonths, COD) ~ Chemo, HGS.N0)
ggsurvplot(fit.N0.bychemo, HGS.N0, pval = TRUE, xlab = "Months", break.time.by = 12, break.y.by = 0.1, legend.title = "Received Chemotherapy", title = "Survival of T1N0M0 patients stratified \nby receipt of chemotherapy", legend.labs = c("Yes", "No/Unknown"), palette = "Set1", ggtheme = theme_gray())
HGS.N0.chemotbl <- table(HGS.N0$Chemo)
kbl(HGS.N0.chemotbl, col.names = c("Received Chemotherapy", "Count")) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
```{r, echo = FALSE}
ph.N0.bychemo <- coxph(Surv(SurvMonths, COD) ~ Chemo, HGS.N0)
ggforest(ph.N0.bychemo, HGS.N0)
summary(ph.N0.bychemo)
```
```{r, echo = FALSE}
knitr::knit_exit()
```

```{r, echo=FALSE}
fit.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = HGS)
ggsurvplot(fit.Black, data = HGS, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of Black Race compared to all other races", legend = "bottom", legend.title = "Race")
```
```{r}
HGS.tbl <- table(HGS$Black.Race)
kbl(HGS.tbl, col.names = c("Black Race", "Count")) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
HGS.chemo.tbl <- table(HGS$Black.Race, HGS$Chemo) 
kbl(HGS.chemo.tbl) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
        add_header_above(c("Black Race", "Chemo Received" = 2))
```
```{r, echo = FALSE}
ph.Black <- coxph(Surv(SurvMonths, COD) ~ Black.Race + Nodes_Pos + Chemo, data = HGS)
ggforest(ph.Black, data = HGS)
```

### Broken down by Stage

```{r, echo=FALSE}
T1.N0.M0.Black <- filter(HGS, Nodes_Pos == "No" & M_Stage == "M0")
T1.Nx.M0.Black <- filter(HGS, Nodes_Pos == "Unk" & M_Stage == "M0")
T1.N1.M0.Black <- filter(HGS, Nodes_Pos == "Yes" & M_Stage == "M0")
mets.Black <- filter(HGS, M_Stage == "M1")
```


#### T1N0M0

```{r, echo=FALSE}
fit.T1.N0.M0.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = T1.N0.M0.Black)
ggsurvplot(fit.T1.N0.M0.Black, data = T1.N0.M0.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1N0M0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(T1.N0.M0.Black$Black.Race)
```
```{r, echo = FALSE}
ph.T1.N0.M0.Black <- coxph(Surv(SurvMonths, COD) ~ Black.Race + Chemo, data = T1.N0.M0.Black)
ggforest(ph.T1.N0.M0.Black, data = T1.N0.M0.Black)
```

#### T1NxM0

```{r, echo=FALSE}
fit.T1.Nx.M0.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = T1.Nx.M0.Black)
ggsurvplot(fit.T1.Nx.M0.Black, data = T1.Nx.M0.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1NxM0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r, echo = FALSE}
T1.Nx.M0.tbl <- table(T1.Nx.M0.Black$Black.Race, T1.Nx.M0.Black$Chemo) 
kbl(T1.Nx.M0.tbl) %>% 
        kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
        add_header_above(c("Black Race", "Chemo Received" = 2))
```
```{r, echo = FALSE}
ph.T1.Nx.M0.Black <- coxph(Surv(SurvMonths, COD) ~ Black.Race + Chemo, data = T1.Nx.M0.Black)
ggforest(ph.T1.Nx.M0.Black, data = T1.Nx.M0.Black)
```
```{r}
table(T1.Nx.M0.Black$Black.Race, T1.Nx.M0.Black$Chemo)
```

#### T1N1M0

```{r, echo=FALSE}
fit.T1.N1.M0.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = T1.N1.M0.Black)
ggsurvplot(fit.T1.N1.M0.Black, data = T1.N1.M0.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1N1M0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(T1.N1.M0.Black$Black.Race)
```
```{r, echo = FALSE}
ph.T1.N1.M0.Black <- coxph(Surv(SurvMonths, COD) ~ Black.Race + Chemo, data = T1.N1.M0.Black)
ggforest(ph.T1.N1.M0.Black, data = T1.N1.M0.Black)
```



#### Metastatic Disease

```{r, echo=FALSE}
fit.mets.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = mets.Black)
ggsurvplot(fit.mets.Black, data = mets.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of Metastatic disease stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(mets.Black$Black.Race)
```

### Broken down by whether or not chemotherapy was received

```{r, echo=FALSE}
chemo.Black <- filter(HGS, Chemo == "Yes")
nochemo.Black <- filter(HGS, Chemo != "Yes")
```

#### With Chemotherapy

```{r, echo=FALSE}
fit.chemo.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = chemo.Black)
ggsurvplot(fit.chemo.Black, data = chemo.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of patients receiving chemotherapy stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(chemo.Black$Black.Race)
```

#### Without Chemotherapy

```{r, echo=FALSE}
fit.nochemo.Black <- survfit(Surv(SurvMonths, COD) ~ Black.Race, data = nochemo.Black)
ggsurvplot(fit.nochemo.Black, data = nochemo.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of patients not receiving chemotherapy stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(nochemo.Black$Black.Race)
```

## Comparing only Black Race to White Race

```{r, echo=FALSE}
fit.White.Black <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = HGS.White.Black)
ggsurvplot(fit.White.Black, data = HGS.White.Black, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(HGS.White.Black$Race.Group)
```

### Broken down by Stage

```{r, echo=FALSE}
T1.N0.M0 <- filter(HGS.White.Black, Nodes_Pos == "No" & M_Stage == "M0")
T1.Nx.M0 <- filter(HGS.White.Black, Nodes_Pos == "Unk" & M_Stage == "M0")
T1.N1.M0 <- filter(HGS.White.Black, Nodes_Pos == "Yes" & M_Stage == "M0")
mets <- filter(HGS.White.Black, M_Stage == "M1")
```

#### T1N0M0

```{r, echo=FALSE}
fit.T1.N0.M0 <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = T1.N0.M0)
ggsurvplot(fit.T1.N0.M0, data = T1.N0.M0, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1N0M0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(T1.N0.M0$Race.Group)
```

#### T1NxM0

```{r, echo=FALSE}
fit.T1.Nx.M0 <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = T1.Nx.M0)
ggsurvplot(fit.T1.Nx.M0, data = T1.Nx.M0, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1NxM0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(T1.Nx.M0$Race.Group)
```

#### T1N1M0

```{r, echo=FALSE}
fit.T1.N1.M0 <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = T1.N1.M0)
ggsurvplot(fit.T1.N1.M0, data = T1.N1.M0, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of T1N1M0 stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(T1.N1.M0$Race.Group)
```

#### Metastatic Disease

```{r, echo=FALSE}
fit.mets <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = mets)
ggsurvplot(fit.mets, data = mets, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of Metastatic disease stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(mets$Race.Group)
```

### Broken down by whether or not chemotherapy was received

```{r, echo=FALSE}
chemo <- filter(HGS.White.Black, Chemo == "Yes")
nochemo <- filter(HGS.White.Black, Chemo != "Yes")
```

#### With Chemotherapy

```{r, echo=FALSE}
fit.chemo <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = chemo)
ggsurvplot(fit.chemo, data = chemo, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of patients receiving chemotherapy stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(chemo$Race.Group)
```

#### Without Chemotherapy

```{r, echo=FALSE}
fit.nochemo <- survfit(Surv(SurvMonths, COD) ~ Race.Group, data = nochemo)
ggsurvplot(fit.nochemo, data = nochemo, pval = TRUE, xlab = "Months", break.time.by = 6, title = "Survival of patients not receiving chemotherapy stratified by Race", legend = "bottom", legend.title = "Race")
```
```{r}
table(nochemo$Race.Group)
```